<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üé∞ 4pu3$t4$_Qva ¬∑ Tu Casa de Apuestas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/css/iziToast.min.css">
    <script src="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(145deg, #1a1e2c 0%, #2d3349 100%);
            color: #fff;
            min-height: 100vh;
            padding-bottom: 30px;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .btn-glow {
            transition: all 0.2s ease;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
        .btn-glow:hover {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
        }
        .neon-text {
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 20px #00ffff;
        }
        .animate-pulse-slow {
            animation: pulse 3s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .hidden-section { display: none; }
        .active-section { display: block; }
        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #00ffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            max-width: 500px;
            width: 90%;
            background: #2d3349;
            border-radius: 24px;
            padding: 20px;
            border: 1px solid #00ffff;
        }
        .error-box {
            background: #ef4444;
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
        }
        .error-box button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .error-box button:hover {
            background: #2563eb;
        }
        .status-active { color: #10b981; font-weight: bold; }
        .status-inactive { color: #6b7280; }
        .status-closed { color: #ef4444; }
        .status-published { color: #10b981; font-weight: bold; }
        .file-input {
            background: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 8px;
            border-radius: 12px;
            width: 100%;
        }
        .file-input::file-selector-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
        }
        .file-input::file-selector-button:hover { background: #1d4ed8; }
        .lottery-btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }
        .lottery-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0,255,255,0.2);
        }
        .lottery-emoji {
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3));
        }
        .method-edit-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        .method-delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        .balance-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            line-height: 1.2;
        }
        .balance-main {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .balance-secondary {
            font-size: 0.7rem;
            color: #9ca3af;
        }
        .withdraw-time-status {
            font-size: 0.85rem;
            padding: 6px 10px;
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
            display: inline-block;
            margin-top: 5px;
        }
        .time-available { color: #10b981; }
        .time-unavailable { color: #f87171; }
        .method-info {
            font-size: 0.9rem;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 12px;
            margin-top: 5px;
        }
        .method-info p {
            margin: 3px 0;
        }
        .bet-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .bet-item:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.01);
        }
        .bet-detail-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 5px;
        }
        .edit-cancel-btn {
            transition: all 0.2s;
        }
        .edit-cancel-btn:hover {
            transform: scale(1.02);
        }
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .balance-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .crypto-warning {
            background: #fbbf24;
            color: #1e293b;
            padding: 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        .crypto-fields {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        .crypto-fields input {
            margin-bottom: 8px;
        }
        .limit-badge {
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .currency-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab-button {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }
        .tab-button.active {
            background: #3b82f6;
            font-weight: bold;
        }
        .pending-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #fbbf24;
        }
        .pending-item.approved { border-left-color: #10b981; }
        .pending-item.rejected { border-left-color: #ef4444; }
    </style>
</head>
<body class="p-4 md:p-6">

<div id="app" class="max-w-4xl mx-auto relative">
    <!-- Header con saldo resumido -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center justify-center shadow-lg">
                <i class="fas fa-dice text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white drop-shadow-lg">4pu3$t4$_Qva</h1>
                <p class="text-xs text-gray-300" id="userName">Cargando...</p>
            </div>
        </div>
        <div class="glass-card px-3 py-2 balance-container">
            <span class="balance-main" id="quickBalance">0.00 CUP</span>
            <span class="balance-secondary" id="quickBalanceUsd">‚âà 0.00 USD</span>
        </div>
    </div>

    <!-- Loader principal -->
    <div id="globalLoader" class="flex justify-center items-center py-20">
        <div class="loader"></div>
        <p class="ml-3 text-sm text-gray-300">Cargando aplicaci√≥n...</p>
    </div>

    <!-- Contenido principal (oculto hasta carga) -->
    <div id="mainContent" class="hidden">
        <!-- Men√∫ inferior fijo -->
        <div class="glass-card fixed bottom-4 left-4 right-4 max-w-4xl mx-auto p-2 flex justify-around z-50">
            <button data-section="home" class="nav-btn flex flex-col items-center p-2 rounded-xl text-white transition-all"><i class="fas fa-home text-2xl"></i><span class="text-xs mt-1">Inicio</span></button>
            <button data-section="play" class="nav-btn flex flex-col items-center p-2 rounded-xl text-white transition-all"><i class="fas fa-gamepad text-2xl"></i><span class="text-xs mt-1">Jugar</span></button>
            <button data-section="wallet" class="nav-btn flex flex-col items-center p-2 rounded-xl text-white transition-all"><i class="fas fa-wallet text-2xl"></i><span class="text-xs mt-1">Mi dinero</span></button>
            <button data-section="bets" class="nav-btn flex flex-col items-center p-2 rounded-xl text-white transition-all"><i class="fas fa-ticket-alt text-2xl"></i><span class="text-xs mt-1">Jugadas</span></button>
            <button data-section="referrals" class="nav-btn flex flex-col items-center p-2 rounded-xl text-white transition-all"><i class="fas fa-users text-2xl"></i><span class="text-xs mt-1">Referidos</span></button>
            <button id="adminNavBtn" data-section="admin" class="nav-btn hidden flex flex-col items-center p-2 rounded-xl text-white transition-all"><i class="fas fa-crown text-2xl"></i><span class="text-xs mt-1">Admin</span></button>
        </div>

        <!-- Contenedor de secciones -->
        <div id="sectionsContainer" class="mt-4 mb-24">
            <!-- SECCI√ìN HOME -->
            <div id="section-home" class="section active-section">
                <div class="glass-card p-6 text-center">
                    <div class="w-24 h-24 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mb-4 shadow-2xl animate-pulse-slow">
                        <i class="fas fa-dice-d6 text-5xl text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bold neon-text mb-2">¬°Bienvenido!</h2>
                    <p class="text-gray-200 mb-6">Selecciona una opci√≥n en el men√∫ inferior para comenzar a jugar y ganar.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/20 p-4 rounded-2xl backdrop-blur-sm">
                            <i class="fas fa-trophy text-3xl text-yellow-300 mb-2"></i>
                            <p class="font-bold">Bono de bienvenida</p>
                            <p class="text-sm text-gray-300" id="welcomeBonus">70 CUP</p>
                        </div>
                        <div class="bg-white/20 p-4 rounded-2xl backdrop-blur-sm">
                            <i class="fas fa-percent text-3xl text-green-300 mb-2"></i>
                            <p class="font-bold">Comisi√≥n referidos</p>
                            <p class="text-sm text-gray-300">5% de por vida</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN JUGAR -->
            <div id="section-play" class="section hidden-section">
                <div class="glass-card p-5">
                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-clock mr-3 text-cyan-300"></i>Elige loter√≠a</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <button data-lottery="Florida" class="lottery-btn bg-gradient-to-br from-red-500 to-orange-500 p-4 rounded-2xl shadow-lg hover:scale-105 transition flex flex-col items-center">
                            <span class="text-4xl mb-2 lottery-emoji">ü¶©</span>
                            <span class="block font-bold">Florida</span>
                        </button>
                        <button data-lottery="Georgia" class="lottery-btn bg-gradient-to-br from-green-600 to-teal-500 p-4 rounded-2xl shadow-lg hover:scale-105 transition flex flex-col items-center">
                            <span class="text-4xl mb-2 lottery-emoji">üçë</span>
                            <span class="block font-bold">Georgia</span>
                        </button>
                        <button data-lottery="Nueva York" class="lottery-btn bg-gradient-to-br from-blue-700 to-indigo-800 p-4 rounded-2xl shadow-lg hover:scale-105 transition flex flex-col items-center">
                            <span class="text-4xl mb-2 lottery-emoji">üóΩ</span>
                            <span class="block font-bold">Nueva York</span>
                        </button>
                    </div>

                    <div id="lotteryScheduleInfo" class="text-sm bg-gray-800/60 p-3 rounded-xl mb-3 hidden"></div>
                    <div id="sessionStatus" class="text-sm mb-3 hidden"></div>

                    <div id="betTypeContainer" class="hidden">
                        <h4 class="text-xl font-semibold mb-3">Tipo de jugada</h4>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button data-type="fijo" class="type-btn bg-blue-600/80 p-3 rounded-xl hover:bg-blue-700">üéØ Fijo</button>
                            <button data-type="corridos" class="type-btn bg-green-600/80 p-3 rounded-xl hover:bg-green-700">üèÉ Corridos</button>
                            <button data-type="centena" class="type-btn bg-purple-600/80 p-3 rounded-xl hover:bg-purple-700">üíØ Centena</button>
                            <button data-type="parle" class="type-btn bg-yellow-600/80 p-3 rounded-xl hover:bg-yellow-700">üîí Parle</button>
                        </div>
                    </div>

                    <div id="betFormContainer" class="hidden">
                        <div id="betInstructions" class="text-sm bg-gray-800/70 p-3 rounded-xl mb-3"></div>
                        <label class="block mb-2 font-medium">‚úçÔ∏è Escribe tus jugadas (una por l√≠nea):</label>
                        <textarea id="betInput" rows="4" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-cyan-500 focus:ring-2 focus:ring-cyan-400"></textarea>
                        <div id="betPreview" class="mt-2 text-xs text-gray-300"></div>
                        <button id="submitBetBtn" class="mt-4 w-full bg-gradient-to-r from-cyan-500 to-blue-600 py-3 rounded-xl font-bold text-lg shadow-lg btn-glow">
                            <i class="fas fa-check-circle mr-2"></i>Registrar apuesta
                        </button>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN MI DINERO -->
            <div id="section-wallet" class="section hidden-section">
                <div class="glass-card p-5">
                    <h3 class="text-2xl font-bold mb-4">üí∞ Mi saldo</h3>
                    
                    <div class="balance-grid">
                        <div class="balance-card">
                            <p class="text-sm opacity-90">üá®üá∫ CUP</p>
                            <p id="walletCup" class="text-2xl font-bold">0.00</p>
                            <p class="text-xs text-gray-300">(principal)</p>
                        </div>
                        <div class="balance-card">
                            <p class="text-sm opacity-90">üíµ USD</p>
                            <p id="walletUsd" class="text-2xl font-bold">0.00</p>
                            <p id="walletUsdEquivalent" class="text-xs text-gray-300">(‚âà 0.00 CUP)</p>
                        </div>
                    </div>

                    <div class="bg-blue-900/50 p-4 rounded-2xl text-center mb-4">
                        <p class="text-sm">üéÅ Bono (no retirable)</p>
                        <p id="walletBonus" class="text-2xl font-semibold text-cyan-300">0.00 CUP</p>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <button id="rechargeBtn" class="bg-indigo-600 p-3 rounded-xl hover:bg-indigo-700 transition"><i class="fas fa-arrow-down mr-1"></i> Recargar</button>
                        <button id="withdrawBtn" class="bg-pink-600 p-3 rounded-xl hover:bg-pink-700 transition"><i class="fas fa-arrow-up mr-1"></i> Retirar</button>
                        <button id="transferBtn" class="bg-gray-600 p-3 rounded-xl hover:bg-gray-700 transition"><i class="fas fa-exchange-alt mr-1"></i> Transferir</button>
                    </div>

                    <div id="withdrawTimeInfo" class="bg-gray-800/50 p-3 rounded-xl text-xs text-center text-gray-300 mb-2">
                        <i class="fas fa-clock mr-1 text-pink-400"></i> 
                        Los retiros est√°n disponibles de <strong>10:00 PM a 11:30 PM</strong> (hora Cuba). 
                        <span id="withdrawTimeStatus" class="withdraw-time-status"></span>
                    </div>

                    <!-- RECARGA -->
                    <div id="rechargeSection" class="hidden mt-6">
                        <h4 class="text-lg font-semibold mb-3">üì• Recargar saldo</h4>
                        <select id="depositMethodSelect" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-indigo-500 mb-3">
                            <option value="">Selecciona m√©todo...</option>
                        </select>
                        <div id="depositMethodInfo" class="method-info hidden"></div>
                        <div id="depositMethodLimits" class="text-xs text-gray-400 mb-2"></div>
                        <input type="file" id="depositScreenshot" accept="image/*" class="file-input mb-3">
                        <input type="text" id="depositAmount" placeholder="Monto (ej: 500 cup, 10 usdt, 100 trx)" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-indigo-500 mb-3">
                        <button id="submitDepositBtn" class="w-full bg-indigo-600 py-3 rounded-xl font-semibold hover:bg-indigo-700">Enviar solicitud</button>
                    </div>

                    <!-- RETIRO -->
                    <div id="withdrawSection" class="hidden mt-6">
                        <h4 class="text-lg font-semibold mb-3">üì§ Retirar saldo</h4>
                        <select id="withdrawMethodSelect" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                            <option value="">Selecciona m√©todo...</option>
                        </select>
                        <div id="withdrawMethodLimits" class="text-xs text-gray-400 mb-2"></div>
                        <input type="number" id="withdrawAmount" step="0.01" min="0" placeholder="Monto a retirar" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                        <p class="text-sm text-gray-300 mb-2">Saldo disponible: <span id="withdrawAvailableBalance">0.00</span> <span id="withdrawCurrency">CUP</span></p>
                        
                        <!-- Campos din√°micos para datos de cuenta -->
                        <div id="withdrawAccountFields" class="space-y-3 mt-3"></div>
                        
                        <button id="submitWithdrawBtn" class="w-full bg-pink-600 py-3 rounded-xl font-semibold hover:bg-pink-700">Solicitar retiro</button>
                    </div>

                    <!-- TRANSFERENCIA (solo CUP y USD) -->
                    <div id="transferSection" class="hidden mt-6">
                        <h4 class="text-lg font-semibold mb-3">üîÑ Transferir saldo</h4>
                        <p class="text-xs text-gray-400 mb-2">‚ö†Ô∏è Solo puedes transferir CUP o USD. El bono de bienvenida no es transferible.</p>
                        <input type="text" id="transferTarget" placeholder="@usuario o ID de Telegram" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-500 mb-3">
                        
                        <select id="transferCurrency" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-500 mb-3">
                            <option value="CUP">CUP</option>
                            <option value="USD">USD</option>
                        </select>
                        
                        <input type="number" id="transferAmount" step="0.01" min="0.01" placeholder="Monto" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-500 mb-3">
                        <p class="text-xs text-gray-400 mb-3" id="transferEquivalent">Equivalente en CUP: 0.00</p>
                        
                        <button id="submitTransferBtn" class="w-full bg-gray-600 py-3 rounded-xl font-semibold hover:bg-gray-700">Transferir</button>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN MIS JUGADAS -->
            <div id="section-bets" class="section hidden-section">
                <div class="glass-card p-5">
                    <h3 class="text-2xl font-bold mb-4">üìã Historial de apuestas</h3>
                    <div id="betsList" class="space-y-3"></div>
                </div>
            </div>

            <!-- SECCI√ìN REFERIDOS -->
            <div id="section-referrals" class="section hidden-section">
                <div class="glass-card p-5">
                    <h3 class="text-2xl font-bold mb-4">üë• Invita y gana</h3>
                    <div class="bg-gradient-to-r from-yellow-600/30 to-pink-600/30 p-5 rounded-2xl text-center mb-4">
                        <i class="fas fa-gift text-5xl text-yellow-300 mb-3"></i>
                        <p class="text-lg font-bold">¬°Gana comisi√≥n de por vida!</p>
                        <p class="text-sm">5% de cada apuesta de tus referidos</p>
                    </div>
                    <div class="bg-gray-800/60 p-4 rounded-xl mb-4">
                        <p class="text-sm text-gray-300 mb-1">Tu enlace de referido:</p>
                        <div class="flex">
                            <input id="referralLink" type="text" readonly class="flex-1 bg-gray-900 p-2 rounded-l-xl text-xs text-cyan-300" value="Cargando...">
                            <button id="copyLinkBtn" class="bg-cyan-600 px-4 rounded-r-xl hover:bg-cyan-700"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center"><span class="font-semibold">Total referidos:</span><span id="referralCount" class="text-2xl font-bold text-yellow-400">0</span></div>
                </div>
            </div>

            <!-- SECCI√ìN ADMIN -->
            <div id="section-admin" class="section hidden-section">
                <div class="glass-card p-5">
                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-crown text-yellow-400 mr-2"></i>Panel Admin</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                        <button data-admin-view="sessions" class="admin-nav-btn bg-indigo-600/80 p-3 rounded-xl hover:bg-indigo-700"><i class="fas fa-calendar-alt mr-1"></i> Sesiones</button>
                        <button data-admin-view="publishWinning" class="admin-nav-btn bg-teal-600/80 p-3 rounded-xl hover:bg-teal-700"><i class="fas fa-trophy mr-1"></i> Publicar Ganadores</button>
                        <button data-admin-view="addDeposit" class="admin-nav-btn bg-blue-600/80 p-3 rounded-xl hover:bg-blue-700"><i class="fas fa-plus mr-1"></i> A√±adir Dep√≥sito</button>
                        <button data-admin-view="addWithdraw" class="admin-nav-btn bg-pink-600/80 p-3 rounded-xl hover:bg-pink-700"><i class="fas fa-plus mr-1"></i> A√±adir Retiro</button>
                        <button data-admin-view="editDeposit" class="admin-nav-btn bg-indigo-400/80 p-3 rounded-xl hover:bg-indigo-500"><i class="fas fa-edit mr-1"></i> Editar Dep√≥sito</button>
                        <button data-admin-view="editWithdraw" class="admin-nav-btn bg-pink-400/80 p-3 rounded-xl hover:bg-pink-500"><i class="fas fa-edit mr-1"></i> Editar Retiro</button>
                        <button data-admin-view="deleteDeposit" class="admin-nav-btn bg-red-600/80 p-3 rounded-xl hover:bg-red-700"><i class="fas fa-trash mr-1"></i> Eliminar Dep√≥sito</button>
                        <button data-admin-view="deleteWithdraw" class="admin-nav-btn bg-red-600/80 p-3 rounded-xl hover:bg-red-700"><i class="fas fa-trash mr-1"></i> Eliminar Retiro</button>
                        <button data-admin-view="setRate" class="admin-nav-btn bg-green-600/80 p-3 rounded-xl hover:bg-green-700"><i class="fas fa-dollar-sign mr-1"></i> Tasas de Cambio</button>
                        <button data-admin-view="setPrices" class="admin-nav-btn bg-purple-600/80 p-3 rounded-xl hover:bg-purple-700"><i class="fas fa-dice mr-1"></i> Pagos, M√≠n y M√°x</button>
                        <button data-admin-view="viewData" class="admin-nav-btn bg-gray-600/80 p-3 rounded-xl hover:bg-gray-700"><i class="fas fa-eye mr-1"></i> Ver Datos</button>
                        <button data-admin-view="pendingRequests" class="admin-nav-btn bg-yellow-600/80 p-3 rounded-xl hover:bg-yellow-700"><i class="fas fa-clock mr-1"></i> Solicitudes Pendientes</button>
                    </div>
                    <div id="adminViewContainer" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL para detalle de jugada -->
<div id="betDetailModal" class="modal hidden" onclick="if(event.target===this) this.classList.add('hidden')">
    <div class="modal-content" id="betDetailModalBody"></div>
</div>

<!-- MODAL para admin (gen√©rico) -->
<div id="adminModal" class="modal hidden" onclick="if(event.target===this) this.classList.add('hidden')">
    <div class="modal-content" id="modalBody"></div>
</div>

<script>
    (function() {
        const TG = window.Telegram.WebApp;
        TG.ready();
        TG.expand();

        // ---------- CONFIGURACI√ìN DE HORARIOS POR LOTER√çA (hora de Cuba) ----------
        const LOTTERY_SCHEDULES = {
            'Florida': [
                { name: 'üåÖ Ma√±ana', start: 9, end: 13 },
                { name: 'üåô Noche', start: 14, end: 21 }
            ],
            'Georgia': [
                { name: 'üåÖ Ma√±ana', start: 9, end: 12 },
                { name: '‚òÄÔ∏è Tarde', start: 14, end: 18.5 },
                { name: 'üåô Noche', start: 20, end: 23 }
            ],
            'Nueva York': [
                { name: 'üåÖ Ma√±ana', start: 9, end: 14 },
                { name: 'üåô Noche', start: 15, end: 22 }
            ]
        };

        const WITHDRAW_START = 22;   // 10:00 PM
        const WITHDRAW_END = 23.5;    // 11:30 PM

        // Estado global
        let currentUser = null;
        let isAdmin = false;
        let exchangeRates = { rate: 110, rate_usdt: 110, rate_trx: 1 };
        let bonusCupDefault = 70;
        let botUsername = '';
        let depositMethods = [];
        let withdrawMethods = [];
        let playPrices = [];
        let activeSession = null;
        let selectedLottery = null;
        let selectedBetType = null;
        let activeSlot = null;
        let userBets = [];

        // Elementos DOM
        const globalLoader = document.getElementById('globalLoader');
        const mainContent = document.getElementById('mainContent');
        const sections = document.querySelectorAll('.section');
        const navBtns = document.querySelectorAll('.nav-btn');
        const adminNavBtns = document.querySelectorAll('.admin-nav-btn');
        const adminViewContainer = document.getElementById('adminViewContainer');
        const adminModal = document.getElementById('adminModal');
        const modalBody = document.getElementById('modalBody');
        const betDetailModal = document.getElementById('betDetailModal');
        const betDetailModalBody = document.getElementById('betDetailModalBody');
        const lotteryScheduleInfo = document.getElementById('lotteryScheduleInfo');
        const sessionStatus = document.getElementById('sessionStatus');
        const betTypeContainer = document.getElementById('betTypeContainer');
        const betFormContainer = document.getElementById('betFormContainer');
        const betInput = document.getElementById('betInput');
        const betPreview = document.getElementById('betPreview');
        const submitBetBtn = document.getElementById('submitBetBtn');
        const welcomeBonus = document.getElementById('welcomeBonus');
        const withdrawTimeStatus = document.getElementById('withdrawTimeStatus');
        const withdrawSection = document.getElementById('withdrawSection');
        const submitWithdrawBtn = document.getElementById('submitWithdrawBtn');
        const withdrawMethodSelect = document.getElementById('withdrawMethodSelect');
        const withdrawAmount = document.getElementById('withdrawAmount');
        const withdrawAvailableBalance = document.getElementById('withdrawAvailableBalance');
        const withdrawCurrency = document.getElementById('withdrawCurrency');
        const depositMethodSelect = document.getElementById('depositMethodSelect');
        const depositAmount = document.getElementById('depositAmount');
        const depositMethodInfo = document.getElementById('depositMethodInfo');
        const depositMethodLimits = document.getElementById('depositMethodLimits');
        const withdrawMethodLimits = document.getElementById('withdrawMethodLimits');
        const withdrawAccountFields = document.getElementById('withdrawAccountFields');

        // Funciones auxiliares
        function getCurrentCubaTime() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('es-CU', { timeZone: 'America/Havana', hour: 'numeric', minute: 'numeric', hour12: false });
            const parts = formatter.formatToParts(now);
            let hour = 0, minute = 0;
            for (const p of parts) {
                if (p.type === 'hour') hour = parseInt(p.value, 10);
                if (p.type === 'minute') minute = parseInt(p.value, 10);
            }
            return { hour, minute, totalHours: hour + minute/60 };
        }

        function isWithdrawTime() {
            const now = getCurrentCubaTime();
            return now.totalHours >= WITHDRAW_START && now.totalHours < WITHDRAW_END;
        }

        function updateWithdrawTimeStatus() {
            if (!withdrawTimeStatus) return;
            const available = isWithdrawTime();
            withdrawTimeStatus.innerHTML = available ? '‚úÖ Disponible ahora' : '‚ùå No disponible (horario: 10:00 PM - 11:30 PM)';
            withdrawTimeStatus.className = `withdraw-time-status ${available ? 'time-available' : 'time-unavailable'}`;
        }

        function onShowWallet() {
            updateWithdrawTimeStatus();
            if (withdrawSection) withdrawSection.classList.add('hidden');
            document.getElementById('rechargeSection')?.classList.add('hidden');
            document.getElementById('transferSection')?.classList.add('hidden');
            updateBalanceUI();
        }

        function showSection(sectionId) {
            sections.forEach(s => {
                s.classList.add('hidden-section');
                s.classList.remove('active-section');
            });
            const active = document.getElementById(`section-${sectionId}`);
            if (active) {
                active.classList.remove('hidden-section');
                active.classList.add('active-section');
            }
            if (sectionId === 'wallet') onShowWallet();
        }

        navBtns.forEach(btn => btn.addEventListener('click', (e) => showSection(e.currentTarget.dataset.section)));

        // Verificar horario de loter√≠as
        function checkLotterySchedule(lottery) {
            const slots = LOTTERY_SCHEDULES[lottery];
            if (!slots) return null;

            const now = getCurrentCubaTime();
            const currentTotal = now.totalHours;

            let active = null;
            for (const s of slots) {
                if (currentTotal >= s.start && currentTotal < s.end) {
                    active = s.name;
                    break;
                }
            }

            let scheduleText = `üïí <b>Horarios ${lottery}:</b><br>`;
            scheduleText += slots.map(s => {
                const startStr = s.start % 1 === 0 ? `${s.start}:00` : `${Math.floor(s.start)}:30`;
                const endStr = s.end % 1 === 0 ? `${s.end}:00` : `${Math.floor(s.end)}:30`;
                return `${s.name} (${startStr}‚Äì${endStr})`;
            }).join(' ‚Ä¢ ');
            if (active) {
                scheduleText += `<br><span class="text-green-400">‚úÖ Ahora puedes jugar en el turno <b>${active}</b></span>`;
            } else {
                scheduleText += `<br><span class="text-red-400">‚è∞ <b>Fuera de horario</b> ¬∑ Intenta en el horario permitido</span>`;
            }
            lotteryScheduleInfo.innerHTML = scheduleText;
            lotteryScheduleInfo.classList.remove('hidden');

            return active;
        }

        document.querySelectorAll('.lottery-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                selectedLottery = btn.dataset.lottery;
                activeSlot = checkLotterySchedule(selectedLottery);

                betTypeContainer.classList.add('hidden');
                betFormContainer.classList.add('hidden');
                sessionStatus.classList.add('hidden');

                if (!activeSlot) {
                    sessionStatus.innerHTML = `<span class="text-red-400">‚ùå No hay turno disponible ahora. Revisa los horarios üëÜ</span>`;
                    sessionStatus.classList.remove('hidden');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                try {
                    const res = await fetch(`/api/lottery-sessions/active?lottery=${encodeURIComponent(selectedLottery)}&date=${today}&time_slot=${encodeURIComponent(activeSlot)}`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const session = await res.json();

                    if (session && session.id && session.status === 'open') {
                        activeSession = session;
                        sessionStatus.innerHTML = `<span class="text-green-400">‚úÖ Turno <b>${activeSlot}</b> abierto ¬∑ Cierre: ${new Date(session.end_time).toLocaleTimeString()}</span>`;
                        sessionStatus.classList.remove('hidden');
                        betTypeContainer.classList.remove('hidden');
                    } else {
                        activeSession = null;
                        sessionStatus.innerHTML = `<span class="text-yellow-400">‚ö†Ô∏è El turno <b>${activeSlot}</b> no est√° abierto. Contacta al administrador.</span>`;
                        sessionStatus.classList.remove('hidden');
                        betTypeContainer.classList.add('hidden');
                    }
                } catch (e) {
                    console.error(e);
                    iziToast.error({ message: 'Error al verificar sesi√≥n' });
                }
            });
        });

        document.querySelectorAll('.type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!activeSession) {
                    iziToast.warning({ message: 'No hay sesi√≥n activa para esta loter√≠a' });
                    return;
                }
                selectedBetType = btn.dataset.type;
                betFormContainer.classList.remove('hidden');
                updateBetInstructions();
            });
        });

        async function updateBetInstructions() {
            const price = playPrices.find(p => p.bet_type === selectedBetType) || {};
            const multiplier = price.payout_multiplier || 500;
            const minCup = price.min_cup || 0;
            const minUsd = price.min_usd || 0;
            const maxCup = price.max_cup !== null ? price.max_cup : '‚àû';
            const maxUsd = price.max_usd !== null ? price.max_usd : '‚àû';

            let instructions = '';
            switch (selectedBetType) {
                case 'fijo':
                    instructions = `üéØ <b>FIJO</b> ‚Äì N√∫mero de 2 d√≠gitos. Usa "D" para decena o "T" para terminal.<br>Ej: 12 con 1 usd, D2 con 5 usd, T5*1cup<br>Varios n√∫meros por l√≠nea: 10 02 78 90 87 con 10 cup`;
                    break;
                case 'corridos':
                    instructions = `üèÉ <b>CORRIDOS</b> ‚Äì N√∫mero de 2 d√≠gitos. Ej: 17 con 0.5 usd, 32 con 10 cup<br>Varios: 17 32 45 con 5 cup`;
                    break;
                case 'centena':
                    instructions = `üíØ <b>CENTENA</b> ‚Äì N√∫mero de 3 d√≠gitos. Ej: 517 con 2 usd, 019*1 usd<br>Varios: 517 019 123 con 2 usd`;
                    break;
                case 'parle':
                    instructions = `üîí <b>PARLE</b> ‚Äì Dos n√∫meros de 2 d√≠gitos separados por "x". Ej: 17x32 con 1 usd, 17x62*2 usd<br>Varios: 17x32 17x62 32x62 con 5 cup`;
                    break;
            }
            instructions += `<br><br>üí∞ <b>Pago:</b> x${multiplier}<br>üìâ <b>M√≠n:</b> ${minCup} CUP / ${minUsd} USD<br>üìà <b>M√°x:</b> ${maxCup} CUP / ${maxUsd} USD`;
            document.getElementById('betInstructions').innerHTML = instructions;
        }

        function parseBetLine(line, betType) {
            line = line.trim().toLowerCase();
            if (!line) return [];

            const match = line.match(/^([\d\s,]+)\s*(?:con|\*)\s*([0-9.]+)\s*(usd|cup)?$/i);
            if (!match) return [];

            let numerosStr = match[1].trim();
            const montoStr = match[2];
            const moneda = (match[3] || 'usd').toLowerCase();

            const numeros = numerosStr.split(/[\s,]+/).filter(n => n.length > 0);
            const montoBase = parseFloat(montoStr);
            if (isNaN(montoBase) || montoBase <= 0) return [];

            const resultados = [];

            for (let numero of numeros) {
                let montoReal = montoBase;
                let numeroGuardado = numero;

                if (betType === 'fijo') {
                    if (/^\d{2}$/.test(numero)) {
                        // normal
                    } else if (/^[Dd](\d)$/.test(numero)) {
                        montoReal = montoBase * 10;
                        numeroGuardado = numero.toUpperCase();
                    } else if (/^[Tt](\d)$/.test(numero)) {
                        montoReal = montoBase * 10;
                        numeroGuardado = numero.toUpperCase();
                    } else {
                        continue;
                    }
                } else if (betType === 'corridos') {
                    if (!/^\d{2}$/.test(numero)) continue;
                } else if (betType === 'centena') {
                    if (!/^\d{3}$/.test(numero)) continue;
                } else if (betType === 'parle') {
                    if (!/^\d{2}x\d{2}$/.test(numero)) continue;
                } else {
                    continue;
                }

                resultados.push({
                    numero: numeroGuardado,
                    usd: moneda === 'usd' ? montoReal : 0,
                    cup: moneda === 'cup' ? montoReal : 0
                });
            }

            return resultados;
        }

        function parseBetMessage(text, betType) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const items = [];
            let totalUSD = 0, totalCUP = 0;

            for (const line of lines) {
                const parsedItems = parseBetLine(line, betType);
                for (const item of parsedItems) {
                    items.push(item);
                    totalUSD += item.usd;
                    totalCUP += item.cup;
                }
            }

            return {
                items,
                totalUSD,
                totalCUP,
                ok: items.length > 0
            };
        }

        betInput.addEventListener('input', function() {
            if (!selectedBetType) return;
            const rawText = this.value;
            const parsed = parseBetMessage(rawText, selectedBetType);
            if (parsed.ok) {
                const totalCUP = parsed.totalCUP;
                const totalUSD = parsed.totalUSD;
                const cupEquivalentUsd = (totalCUP / exchangeRates.rate).toFixed(2);
                const usdEquivalentCup = (totalUSD * exchangeRates.rate).toFixed(2);
                betPreview.innerHTML = `üí∞ Total: ${totalCUP.toFixed(2)} CUP / ${totalUSD.toFixed(2)} USD<br>${totalCUP > 0 ? `(equivale a ${cupEquivalentUsd} USD)` : ''} ${totalUSD > 0 ? `(equivale a ${usdEquivalentCup} CUP)` : ''}`;
            } else {
                betPreview.innerHTML = '‚ùå Formato no v√°lido';
            }
        });

        submitBetBtn.addEventListener('click', async () => {
            if (!activeSession) { iziToast.error({ message: 'No hay sesi√≥n activa' }); return; }
            const rawText = betInput.value.trim();
            if (!rawText || !selectedBetType) { iziToast.warning({ message: 'Escribe tus jugadas' }); return; }
            
            const parsed = parseBetMessage(rawText, selectedBetType);
            if (!parsed.ok) {
                iziToast.warning({ message: 'Formato de jugada inv√°lido' });
                return;
            }

            // Validar l√≠mites m√°ximos
            const price = playPrices.find(p => p.bet_type === selectedBetType) || {};
            const maxCup = price.max_cup;
            const maxUsd = price.max_usd;
            for (const item of parsed.items) {
                if (maxCup !== null && item.cup > maxCup) {
                    iziToast.error({ message: `Cada jugada en CUP no puede exceder ${maxCup} CUP.` });
                    return;
                }
                if (maxUsd !== null && item.usd > maxUsd) {
                    iziToast.error({ message: `Cada jugada en USD no puede exceder ${maxUsd} USD.` });
                    return;
                }
            }

            try {
                const res = await fetch('/api/bets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        lottery: selectedLottery,
                        betType: selectedBetType,
                        rawText,
                        sessionId: activeSession.id
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    iziToast.success({ title: '‚úÖ Jugada registrada', message: '¬°Buena suerte!' });
                    currentUser = data.updatedUser;
                    updateBalanceUI();
                    loadBets();
                    betInput.value = '';
                    betPreview.innerHTML = '';
                    showSection('home');
                } else {
                    iziToast.error({ title: 'Error', message: data.error || 'No se pudo registrar' });
                }
            } catch (e) {
                console.error(e);
                iziToast.error({ message: 'Error de conexi√≥n' });
            }
        });

        async function initAuth() {
            try {
                const initData = TG.initData;
                if (!initData) throw new Error('No initData');

                // Timeout para la petici√≥n
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos

                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    let errorMsg = `Error ${response.status}`;
                    try {
                        const errData = await response.json();
                        errorMsg = errData.error || errorMsg;
                    } catch (e) {}
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                
                // Verificar que data.user existe
                if (!data.user) {
                    throw new Error('El servidor no devolvi√≥ datos de usuario');
                }

                currentUser = data.user;
                isAdmin = data.isAdmin || false;
                exchangeRates = {
                    rate: data.exchangeRate || 110,
                    rate_usdt: data.exchangeRateUSDT || 110,
                    rate_trx: data.exchangeRateTRX || 1
                };
                botUsername = data.botUsername || '4pu3$t4$_QvaBot';
                bonusCupDefault = data.bonusCupDefault || 70;
                
                if (welcomeBonus) {
                    welcomeBonus.innerText = `${bonusCupDefault} CUP`;
                }

                document.getElementById('userName').innerText = currentUser.first_name || 'Jugador';
                updateBalanceUI();

                if (isAdmin) {
                    document.getElementById('adminNavBtn').classList.remove('hidden');
                }

                await Promise.allSettled([
                    loadDepositMethods(),
                    loadWithdrawMethods(),
                    loadPlayPrices(),
                    loadBets(),
                    loadReferralStats()
                ]);

                globalLoader.classList.add('hidden');
                mainContent.classList.remove('hidden');

                anime({ targets: '.glass-card', opacity: [0,1], translateY: [20,0], duration: 800 });

                updateWithdrawTimeStatus();

            } catch (e) {
                console.error('Error en initAuth:', e);
                globalLoader.innerHTML = `
                    <div class="error-box">
                        <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                        <p class="text-xl font-bold mb-2">Error de conexi√≥n</p>
                        <p class="text-sm mb-4">${e.message || 'No se pudo cargar la sesi√≥n.'}</p>
                        <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl">
                            <i class="fas fa-sync-alt mr-2"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }

        function updateBalanceUI() {
            if (!currentUser) return;
            const cup = parseFloat(currentUser.cup) || 0;
            const usd = parseFloat(currentUser.usd) || 0;
            const bonusCup = parseFloat(currentUser.bonus_cup) || 0;
            
            document.getElementById('quickBalance').innerText = `${cup.toFixed(2)} CUP`;
            document.getElementById('quickBalanceUsd').innerText = `‚âà ${(cup / exchangeRates.rate).toFixed(2)} USD`;
            
            document.getElementById('walletCup').innerText = cup.toFixed(2);
            document.getElementById('walletUsd').innerText = usd.toFixed(2);
            document.getElementById('walletUsdEquivalent').innerText = `‚âà ${(usd * exchangeRates.rate).toFixed(2)} CUP`;
            document.getElementById('walletBonus').innerText = `${bonusCup.toFixed(2)} CUP`;
        }

        async function loadDepositMethods() {
            try {
                const res = await fetch('/api/deposit-methods');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                depositMethods = await res.json();
                const select = document.getElementById('depositMethodSelect');
                if (select) {
                    select.innerHTML = '<option value="">Selecciona m√©todo...</option>';
                    depositMethods.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = m.name + (m.currency ? ` (${m.currency})` : '');
                        select.appendChild(option);
                    });
                }
                
                select.addEventListener('change', function() {
                    const methodId = this.value;
                    if (methodId) {
                        const method = depositMethods.find(m => m.id == methodId);
                        if (method) {
                            depositMethodInfo.innerHTML = `
                                <p><strong>${escapeHTML(method.name)}</strong></p>
                                <p>üì± Datos: <code>${escapeHTML(method.card)}</code></p>
                                <p>‚úÖ Confirmar: <code>${escapeHTML(method.confirm)}</code></p>
                            `;
                            depositMethodInfo.classList.remove('hidden');
                            let limitsHtml = '';
                            if (method.min_amount !== null || method.max_amount !== null) {
                                limitsHtml = '<span class="font-semibold">L√≠mites:</span> ';
                                if (method.min_amount !== null) limitsHtml += `M√≠n: ${method.min_amount} ${method.currency} `;
                                if (method.max_amount !== null) limitsHtml += `M√°x: ${method.max_amount} ${method.currency}`;
                                depositMethodLimits.innerHTML = limitsHtml;
                            } else {
                                depositMethodLimits.innerHTML = '';
                            }
                        } else {
                            depositMethodInfo.classList.add('hidden');
                            depositMethodLimits.innerHTML = '';
                        }
                    } else {
                        depositMethodInfo.classList.add('hidden');
                        depositMethodLimits.innerHTML = '';
                    }
                });
            } catch (e) { 
                console.error('loadDepositMethods', e);
                iziToast.error({ message: 'Error al cargar m√©todos de dep√≥sito' });
            }
        }

        async function loadWithdrawMethods() {
            try {
                const res = await fetch('/api/withdraw-methods');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                withdrawMethods = await res.json();
                const select = document.getElementById('withdrawMethodSelect');
                if (select) {
                    select.innerHTML = '<option value="">Selecciona m√©todo...</option>';
                    withdrawMethods.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = m.name + (m.currency ? ` (${m.currency})` : '');
                        select.appendChild(option);
                    });
                }

                select.addEventListener('change', function() {
                    const methodId = this.value;
                    if (methodId) {
                        const method = withdrawMethods.find(m => m.id == methodId);
                        if (method) {
                            const currency = method.currency || 'CUP';
                            let balance = 0;
                            switch (currency) {
                                case 'CUP': balance = parseFloat(currentUser.cup) || 0; break;
                                case 'USD': balance = parseFloat(currentUser.usd) || 0; break;
                                default:
                                    balance = (parseFloat(currentUser.cup) || 0) / (currency === 'USDT' ? exchangeRates.rate_usdt : exchangeRates.rate_trx);
                                    break;
                            }
                            withdrawAvailableBalance.innerText = balance.toFixed(2);
                            withdrawCurrency.innerText = currency;

                            let limitsHtml = '';
                            if (method.min_amount !== null || method.max_amount !== null) {
                                limitsHtml = '<span class="font-semibold">L√≠mites:</span> ';
                                if (method.min_amount !== null) limitsHtml += `M√≠n: ${method.min_amount} ${currency} `;
                                if (method.max_amount !== null) limitsHtml += `M√°x: ${method.max_amount} ${currency}`;
                                withdrawMethodLimits.innerHTML = limitsHtml;
                            } else {
                                withdrawMethodLimits.innerHTML = '';
                            }

                            // Mostrar campos din√°micos seg√∫n moneda
                            renderWithdrawFields(method);
                        }
                    } else {
                        withdrawMethodLimits.innerHTML = '';
                        withdrawAccountFields.innerHTML = '';
                    }
                });
            } catch (e) { 
                console.error('loadWithdrawMethods', e);
                iziToast.error({ message: 'Error al cargar m√©todos de retiro' });
            }
        }

        function renderWithdrawFields(method) {
            const currency = method.currency || 'CUP';
            let html = '';

            if (currency === 'USDT' || currency === 'TRX') {
                // Cripto: wallet y red
                html = `
                    <div>
                        <label class="block text-sm font-medium mb-1">Direcci√≥n de wallet</label>
                        <input type="text" id="withdrawWallet" placeholder="${escapeHTML(method.card) || 'Direcci√≥n de wallet'}" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Red</label>
                        <input type="text" id="withdrawNetwork" placeholder="${escapeHTML(method.confirm) || 'Indique la red (TRC-20, BEP-20, etc.)'}" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500">
                    </div>
                `;
            } else {
                // Fiat: dos campos personalizados (tarjeta y confirmaci√≥n)
                html = `
                    <div>
                        <label class="block text-sm font-medium mb-1">N√∫mero de tarjeta / cuenta</label>
                        <input type="text" id="withdrawCard" placeholder="${escapeHTML(method.card) || 'Ej: 1234-5678-9012-3456'}" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">N√∫mero a confirmar</label>
                        <input type="text" id="withdrawConfirm" placeholder="${escapeHTML(method.confirm) || 'Ej: 1234'}" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500">
                    </div>
                `;
            }

            withdrawAccountFields.innerHTML = html;
        }

        async function loadPlayPrices() {
            try { 
                const res = await fetch('/api/play-prices'); 
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                playPrices = await res.json(); 
            } catch (e) { 
                console.error(e);
                iziToast.error({ message: 'Error al cargar precios' });
            }
        }

        async function loadBets() {
            if (!currentUser) return;
            try {
                const res = await fetch(`/api/user/${currentUser.telegram_id}/bets?limit=20`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const bets = await res.json();
                userBets = bets;
                renderBetsList(bets);
            } catch (e) { 
                console.error(e);
                iziToast.error({ message: 'Error al cargar historial' });
            }
        }

        function renderBetsList(bets) {
            const container = document.getElementById('betsList');
            if (!bets || bets.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No tienes jugadas a√∫n.</p>';
                return;
            }
            
            let html = '';
            bets.forEach(b => {
                const date = new Date(b.placed_at).toLocaleString();
                html += `<div class="bg-gray-800/50 p-3 rounded-xl bet-item" onclick="showBetDetail(${b.id})">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold">üé∞ ${b.lottery} - ${b.bet_type}</span>
                            <p class="text-xs text-gray-400">${date}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-cyan-300">${b.cost_cup} CUP</span>
                            <span class="text-gray-400 text-xs block">${b.cost_usd} USD</span>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        window.showBetDetail = async (betId) => {
            const bet = userBets.find(b => b.id === betId);
            if (!bet) return;

            let sessionOpen = false;
            if (bet.session_id) {
                try {
                    const res = await fetch(`/api/lottery-sessions/${bet.session_id}`);
                    if (res.ok) {
                        const session = await res.json();
                        sessionOpen = session && session.status === 'open';
                    }
                } catch (e) {}
            }

            let itemsHtml = '';
            if (bet.items && bet.items.length > 0) {
                bet.items.forEach(item => {
                    itemsHtml += `<div class="bet-detail-item">
                        <span class="font-mono">${escapeHTML(item.numero)}</span>
                        <span class="float-right">${item.cup > 0 ? item.cup + ' CUP' : ''} ${item.usd > 0 ? item.usd + ' USD' : ''}</span>
                    </div>`;
                });
            } else {
                itemsHtml = '<p class="text-gray-400">No hay detalles</p>';
            }

            const actionsHtml = sessionOpen ? `
                <div class="flex gap-2 mt-4">
                    <button onclick="editBet(${bet.id})" class="flex-1 bg-blue-600 py-2 rounded-lg edit-cancel-btn">‚úèÔ∏è Editar</button>
                    <button onclick="cancelBet(${bet.id})" class="flex-1 bg-red-600 py-2 rounded-lg edit-cancel-btn">üóë Cancelar</button>
                </div>
            ` : '';

            betDetailModalBody.innerHTML = `
                <h4 class="text-xl font-bold mb-2">Detalles de la jugada</h4>
                <p class="text-sm text-gray-300 mb-1">üé∞ ${bet.lottery} - ${bet.bet_type}</p>
                <p class="text-xs text-gray-400 mb-3">${new Date(bet.placed_at).toLocaleString()}</p>
                
                <div class="mb-3">
                    <p class="font-semibold mb-1">üìù N√∫meros jugados:</p>
                    ${itemsHtml}
                </div>
                
                <div class="bg-gray-700/50 p-2 rounded-lg text-right">
                    <p>Total: <span class="text-cyan-300">${bet.cost_cup} CUP</span> / <span class="text-yellow-300">${bet.cost_usd} USD</span></p>
                </div>
                
                ${actionsHtml}
                
                <button onclick="document.getElementById('betDetailModal').classList.add('hidden')" class="mt-4 w-full bg-gray-600 py-2 rounded-lg">Cerrar</button>
            `;
            betDetailModal.classList.remove('hidden');
        };

        window.editBet = (betId) => {
            const bet = userBets.find(b => b.id === betId);
            if (!bet) return;

            showSection('play');
            
            const lotteryBtn = document.querySelector(`[data-lottery="${bet.lottery}"]`);
            if (lotteryBtn) {
                lotteryBtn.click();
                
                setTimeout(() => {
                    const typeBtn = document.querySelector(`[data-type="${bet.bet_type}"]`);
                    if (typeBtn) {
                        typeBtn.click();
                        setTimeout(() => {
                            betInput.value = bet.raw_text;
                            betInput.dispatchEvent(new Event('input'));
                            iziToast.info({ message: 'Jugada cargada para editar. Puedes modificarla y registrar de nuevo.' });
                        }, 500);
                    }
                }, 1000);
            }
            
            betDetailModal.classList.add('hidden');
        };

        window.cancelBet = async (betId) => {
            if (!confirm('¬øEst√°s seguro de cancelar esta jugada? Se te reembolsar√° el monto.')) return;
            
            const bet = userBets.find(b => b.id === betId);
            if (!bet) return;

            try {
                const res = await fetch(`/api/bets/${betId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.telegram_id })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    iziToast.success({ message: 'Jugada cancelada y saldo reembolsado' });
                    currentUser = data.updatedUser;
                    updateBalanceUI();
                    loadBets();
                    betDetailModal.classList.add('hidden');
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error || 'Error al cancelar' });
                }
            } catch (e) {
                iziToast.error({ message: 'Error de conexi√≥n' });
            }
        };

        async function loadReferralStats() {
            if (!currentUser) return;
            try {
                const res = await fetch(`/api/user/${currentUser.telegram_id}/referrals/count`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                document.getElementById('referralCount').innerText = data.count || 0;
                const link = `https://t.me/${botUsername}?start=${currentUser.telegram_id}`;
                document.getElementById('referralLink').value = link;
            } catch (e) { 
                console.error(e);
                iziToast.error({ message: 'Error al cargar referidos' });
            }
        }

        document.getElementById('rechargeBtn').addEventListener('click', () => {
            document.getElementById('rechargeSection').classList.toggle('hidden');
            document.getElementById('withdrawSection').classList.add('hidden');
            document.getElementById('transferSection').classList.add('hidden');
        });
        document.getElementById('withdrawBtn').addEventListener('click', () => {
            document.getElementById('withdrawSection').classList.toggle('hidden');
            document.getElementById('rechargeSection').classList.add('hidden');
            document.getElementById('transferSection').classList.add('hidden');
        });
        document.getElementById('transferBtn').addEventListener('click', () => {
            document.getElementById('transferSection').classList.toggle('hidden');
            document.getElementById('rechargeSection').classList.add('hidden');
            document.getElementById('withdrawSection').classList.add('hidden');
        });

        document.getElementById('transferCurrency').addEventListener('change', updateTransferEquivalent);
        document.getElementById('transferAmount').addEventListener('input', updateTransferEquivalent);

        function updateTransferEquivalent() {
            const currency = document.getElementById('transferCurrency').value;
            const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
            let eq = currency === 'CUP' ? amount : amount * exchangeRates.rate;
            document.getElementById('transferEquivalent').innerText = `Equivalente en CUP: ${eq.toFixed(2)}`;
        }

        document.getElementById('submitDepositBtn').addEventListener('click', async () => {
            const methodId = document.getElementById('depositMethodSelect').value;
            const file = document.getElementById('depositScreenshot').files[0];
            const amount = document.getElementById('depositAmount').value.trim();
            if (!methodId || !file || !amount) { iziToast.warning({ message: 'Completa todos los campos' }); return; }

            const parsed = parseAmountWithCurrency(amount);
            if (!parsed) {
                iziToast.warning({ message: 'Formato inv√°lido. Ej: 500 cup, 10 usdt, 100 trx' });
                return;
            }

            const method = depositMethods.find(m => m.id == methodId);
            if (!method) return;

            if (method.currency !== parsed.currency) {
                iziToast.warning({ message: `Este m√©todo es en ${method.currency}, no coincide con el monto.` });
                return;
            }

            if (method.min_amount !== null && parsed.amount < method.min_amount) {
                iziToast.warning({ message: `Monto m√≠nimo: ${method.min_amount} ${method.currency}` });
                return;
            }
            if (method.max_amount !== null && parsed.amount > method.max_amount) {
                iziToast.warning({ message: `Monto m√°ximo: ${method.max_amount} ${method.currency}` });
                return;
            }

            const formData = new FormData();
            formData.append('methodId', methodId);
            formData.append('userId', currentUser.telegram_id);
            formData.append('amount', amount);
            formData.append('currency', parsed.currency);
            formData.append('screenshot', file);
            try {
                const res = await fetch('/api/deposit-requests', { method: 'POST', body: formData });
                if (res.ok) {
                    iziToast.success({ message: 'Solicitud enviada' });
                    document.getElementById('rechargeSection').classList.add('hidden');
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error || 'Error' });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        });

        submitWithdrawBtn.addEventListener('click', async () => {
            if (!isWithdrawTime()) {
                iziToast.error({ 
                    title: 'Fuera de horario', 
                    message: 'Los retiros solo est√°n disponibles de 10:00 PM a 11:30 PM (hora Cuba).' 
                });
                return;
            }

            const methodId = withdrawMethodSelect.value;
            const amount = parseFloat(withdrawAmount.value);
            if (!methodId || isNaN(amount) || amount <= 0) {
                iziToast.warning({ message: 'Selecciona m√©todo e ingresa un monto v√°lido' });
                return;
            }

            const method = withdrawMethods.find(m => m.id == methodId);
            if (!method) return;
            const currency = method.currency || 'CUP';
            
            let balance = 0;
            if (currency === 'CUP') balance = parseFloat(currentUser.cup) || 0;
            else if (currency === 'USD') balance = parseFloat(currentUser.usd) || 0;
            else {
                const cupBalance = parseFloat(currentUser.cup) || 0;
                const requiredCUP = amount * (currency === 'USDT' ? exchangeRates.rate_usdt : exchangeRates.rate_trx);
                if (cupBalance < requiredCUP) {
                    iziToast.warning({ message: `Saldo CUP insuficiente. Necesitas ${requiredCUP.toFixed(2)} CUP.` });
                    return;
                }
                balance = amount;
            }

            if (currency === 'CUP' && amount > balance) {
                iziToast.warning({ message: `Saldo insuficiente. Disponible: ${balance.toFixed(2)} CUP` });
                return;
            }
            if (currency === 'USD' && amount > balance) {
                iziToast.warning({ message: `Saldo insuficiente. Disponible: ${balance.toFixed(2)} USD` });
                return;
            }

            if (method.min_amount !== null && amount < method.min_amount) {
                iziToast.warning({ message: `Monto m√≠nimo: ${method.min_amount} ${currency}` });
                return;
            }
            if (method.max_amount !== null && amount > method.max_amount) {
                iziToast.warning({ message: `Monto m√°ximo: ${method.max_amount} ${currency}` });
                return;
            }

            // Recoger datos de cuenta seg√∫n el tipo
            let accountInfo = '';
            if (currency === 'USDT' || currency === 'TRX') {
                const wallet = document.getElementById('withdrawWallet')?.value.trim();
                const network = document.getElementById('withdrawNetwork')?.value.trim();
                if (!wallet || !network) {
                    iziToast.warning({ message: 'Debes ingresar direcci√≥n de wallet y red' });
                    return;
                }
                accountInfo = `Wallet: ${wallet} (Red: ${network})`;
            } else {
                const card = document.getElementById('withdrawCard')?.value.trim();
                const confirm = document.getElementById('withdrawConfirm')?.value.trim();
                if (!card || !confirm) {
                    iziToast.warning({ message: 'Debes ingresar todos los datos de la cuenta' });
                    return;
                }
                accountInfo = `Tarjeta: ${card} | Confirmaci√≥n: ${confirm}`;
            }

            try {
                const res = await fetch('/api/withdraw-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        methodId, 
                        amount, 
                        currency,
                        userId: currentUser.telegram_id,
                        accountInfo
                    })
                });
                if (res.ok) {
                    iziToast.success({ message: 'Solicitud enviada' });
                    document.getElementById('withdrawSection').classList.add('hidden');
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error || 'Error' });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        });

        document.getElementById('submitTransferBtn').addEventListener('click', async () => {
            const targetInput = document.getElementById('transferTarget').value.trim();
            const currency = document.getElementById('transferCurrency').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            
            if (!targetInput || isNaN(amount) || amount <= 0) {
                iziToast.warning({ message: 'Ingresa un usuario v√°lido y un monto positivo' });
                return;
            }

            let balance = currency === 'CUP' ? (parseFloat(currentUser.cup) || 0) : (parseFloat(currentUser.usd) || 0);
            if (amount > balance) {
                iziToast.warning({ message: `Saldo insuficiente en ${currency}. Disponible: ${balance.toFixed(2)}` });
                return;
            }

            let identifier = targetInput;
            if (identifier.startsWith('@')) identifier = identifier.slice(1);

            try {
                const res = await fetch('/api/transfer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        from: currentUser.telegram_id, 
                        to: identifier,
                        amount,
                        currency
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    iziToast.success({ message: 'Transferencia realizada' });
                    document.getElementById('transferSection').classList.add('hidden');
                    if (currency === 'CUP') currentUser.cup -= amount;
                    else currentUser.usd -= amount;
                    updateBalanceUI();
                } else {
                    iziToast.error({ message: data.error || 'Error al transferir' });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        });

        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            const link = document.getElementById('referralLink');
            link.select();
            document.execCommand('copy');
            iziToast.success({ message: 'Enlace copiado' });
        });

        // ========== FUNCIONES DE ADMIN (completas) ==========

        async function renderSessionsView() {
            const today = new Date().toISOString().split('T')[0];
            let sessions = [];
            try {
                const res = await fetch(`/api/admin/lottery-sessions?date=${today}&userId=${currentUser.telegram_id}`);
                if (res.ok) sessions = await res.json();
            } catch (e) { console.warn('Error fetching sessions', e); }

            let html = `<h4 class="text-xl font-semibold mb-4">üé∞ Gesti√≥n de Sesiones</h4>`;
            for (const [lottery, slots] of Object.entries(LOTTERY_SCHEDULES)) {
                html += `<div class="mb-4 bg-gray-800/30 p-3 rounded-xl"><h5 class="font-bold text-lg mb-2">${lottery}</h5><div class="grid grid-cols-${slots.length} gap-2">`;
                for (const slot of slots) {
                    const session = sessions.find(s => s.lottery === lottery && s.time_slot === slot.name && s.date === today);
                    let estado, clase, accion;
                    if (session) {
                        if (session.status === 'open') { estado = '‚úÖ ACTIVA'; clase = 'status-active'; accion = 'Cerrar'; }
                        else { estado = 'üî¥ CERRADA'; clase = 'status-closed'; accion = 'Abrir'; }
                    } else { estado = '‚ö™ INACTIVA'; clase = 'status-inactive'; accion = 'Abrir'; }

                    html += `<div class="bg-gray-700/50 p-2 rounded-lg text-center">
                        <span class="block text-sm">${slot.name}</span>
                        <span class="${clase} text-xs">${estado}</span>
                        <button onclick="toggleSession('${lottery}', '${slot.name}', ${session ? session.id : 'null'}, '${session ? session.status : 'closed'}')" 
                            class="mt-2 bg-${session && session.status === 'open' ? 'red' : 'green'}-600 px-3 py-1 rounded-lg text-xs w-full">${accion}</button>
                    </div>`;
                }
                html += `</div></div>`;
            }
            html += `<button onclick="renderSessionsView()" class="mt-2 bg-blue-600 px-4 py-2 rounded-xl text-sm">üîÑ Actualizar</button>`;
            adminViewContainer.innerHTML = html;
        }

        window.toggleSession = async (lottery, timeSlot, sessionId, currentStatus) => {
            if (sessionId) {
                const newStatus = currentStatus === 'open' ? 'closed' : 'open';
                try {
                    const res = await fetch('/api/admin/lottery-sessions/toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId, status: newStatus, userId: currentUser.telegram_id })
                    });
                    if (res.ok) {
                        iziToast.success({ message: `Sesi√≥n ${newStatus==='open'?'abierta':'cerrada'}` });
                        renderSessionsView();
                    } else {
                        const err = await res.json();
                        iziToast.error({ message: err.error });
                    }
                } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
            } else {
                try {
                    const res = await fetch('/api/admin/lottery-sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lottery, time_slot: timeSlot, userId: currentUser.telegram_id })
                    });
                    if (res.ok) {
                        iziToast.success({ message: `Sesi√≥n de ${lottery} (${timeSlot}) abierta` });
                        renderSessionsView();
                    } else {
                        const err = await res.json();
                        iziToast.error({ message: err.error });
                    }
                } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
            }
        };

        async function renderPublishWinningView() {
            try {
                const res = await fetch(`/api/admin/lottery-sessions/closed?userId=${currentUser.telegram_id}`);
                const sessions = await res.json();
                const pubRes = await fetch('/api/winning-numbers');
                const published = await pubRes.json();
                const publishedSet = new Set(published.map(p => `${p.lottery}|${p.date}|${p.time_slot}`));
                let html = `<h4 class="text-xl font-semibold mb-4">üî¢ Publicar n√∫meros ganadores</h4><p class="mb-2 text-sm text-yellow-300">‚ö†Ô∏è 7 d√≠gitos (centena+cuarteta). Puedes separar con espacio: 123 4567</p>`;
                if (sessions.length === 0) html += '<p class="text-gray-400">No hay sesiones cerradas.</p>';
                else {
                    sessions.forEach(s => {
                        const isPublished = publishedSet.has(`${s.lottery}|${s.date}|${s.time_slot}`);
                        html += `<div class="bg-gray-800/70 p-4 rounded-xl flex justify-between items-center mb-2"><div><span class="font-bold">${s.lottery} ${s.time_slot}</span><span class="text-sm ml-2">${s.date}</span>${isPublished?'<span class="ml-2 text-green-400">‚úÖ publicado</span>':''}</div>`;
                        if (!isPublished) html += `<button onclick="publishWinning(${s.id})" class="bg-teal-600 px-4 py-2 rounded-lg">üì¢ Publicar</button>`;
                        else html += `<button onclick="showWinners(${s.id})" class="bg-blue-600 px-4 py-2 rounded-lg">üëÅÔ∏è Ver ganadores</button>`;
                        html += `</div>`;
                    });
                }
                adminViewContainer.innerHTML = html;
            } catch (e) { adminViewContainer.innerHTML = '<p class="text-red-400">Error al cargar sesiones.</p>'; }
        }

        window.publishWinning = async (sessionId) => {
            const number = prompt('N√∫mero ganador de 7 D√çGITOS (puedes separar con espacio, ej: 517 3262):');
            if (!number) return;
            const clean = number.replace(/\s+/g, '');
            if (!/^\d{7}$/.test(clean)) { iziToast.error({ message: 'Debe tener 7 d√≠gitos' }); return; }
            try {
                const res = await fetch('/api/admin/winning-numbers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId, winningNumber: clean, userId: currentUser.telegram_id })
                });
                if (res.ok) {
                    iziToast.success({ message: '‚úÖ N√∫meros publicados. Los ganadores recibir√°n notificaci√≥n.' });
                    renderPublishWinningView();
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error || 'Error al publicar' });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        };

        window.showWinners = async (sessionId) => {
            try {
                const res = await fetch(`/api/admin/winning-numbers/${sessionId}/winners?userId=${currentUser.telegram_id}`);
                const data = await res.json();
                let modalContent = `<h4 class="text-xl font-bold mb-4">üèÜ Ganadores de la sesi√≥n</h4>`;
                if (!data.winning_number) {
                    modalContent += `<p class="text-yellow-300">A√∫n no se ha publicado n√∫mero ganador.</p>`;
                } else {
                    const winningNumber = data.winning_number;
                    const formattedNumber = winningNumber.length === 7 ? winningNumber.slice(0,3) + ' ' + winningNumber.slice(3) : winningNumber;
                    modalContent += `<p class="mb-3">üî¢ N√∫mero ganador: <span class="font-mono bg-gray-900 px-2 py-1 rounded">${formattedNumber}</span></p>`;
                    if (data.winners.length === 0) {
                        modalContent += `<p class="text-gray-400">No hubo ganadores en esta sesi√≥n.</p>`;
                    } else {
                        modalContent += `<div class="space-y-2 max-h-96 overflow-y-auto">`;
                        data.winners.forEach(w => {
                            modalContent += `<div class="bg-gray-700/50 p-3 rounded-lg"><div class="flex justify-between"><span class="font-bold">${escapeHTML(w.first_name)}</span><span class="text-cyan-300">${w.prize_cup.toFixed(2)} CUP / ${w.prize_usd.toFixed(2)} USD</span></div><p class="text-xs text-gray-400 mt-1">${escapeHTML(w.bet_text)}</p></div>`;
                        });
                        modalContent += `</div>`;
                    }
                }
                modalContent += `<button onclick="document.getElementById('adminModal').classList.add('hidden')" class="mt-4 w-full bg-gray-600 py-2 rounded-lg">Cerrar</button>`;
                modalBody.innerHTML = modalContent;
                adminModal.classList.remove('hidden');
            } catch (e) { iziToast.error({ message: 'Error al cargar ganadores' }); }
        };

        function renderAddDepositView() {
            adminViewContainer.innerHTML = `
                <h4 class="text-xl font-semibold mb-4">‚ûï A√±adir m√©todo de DEP√ìSITO</h4>
                <input type="text" id="depName" placeholder="Nombre" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-cyan-500 mb-3">
                <input type="text" id="depCard" placeholder="N√∫mero de tarjeta / wallet" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-cyan-500 mb-3">
                <input type="text" id="depConfirm" placeholder="N√∫mero a confirmar / red" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-cyan-500 mb-3">
                <select id="depCurrency" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-cyan-500 mb-3">
                    <option value="CUP">CUP</option>
                    <option value="USD">USD</option>
                    <option value="USDT">USDT</option>
                    <option value="TRX">TRX</option>
                    <option value="MLC">MLC</option>
                </select>
                <input type="number" id="depMinAmount" placeholder="L√≠mite m√≠nimo (0 = sin l√≠mite)" step="0.01" min="0" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-cyan-500 mb-3">
                <input type="number" id="depMaxAmount" placeholder="L√≠mite m√°ximo (0 = sin l√≠mite)" step="0.01" min="0" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-cyan-500 mb-3">
                <button id="saveDepositMethodBtn" class="w-full bg-green-600 py-3 rounded-xl font-semibold hover:bg-green-700">Guardar</button>
            `;
            document.getElementById('saveDepositMethodBtn')?.addEventListener('click', async () => {
                const name = document.getElementById('depName').value.trim();
                const card = document.getElementById('depCard').value.trim();
                const confirm = document.getElementById('depConfirm').value.trim();
                const currency = document.getElementById('depCurrency').value;
                const minAmount = parseFloat(document.getElementById('depMinAmount').value);
                const maxAmount = parseFloat(document.getElementById('depMaxAmount').value);
                if (!name || !card || !confirm) { iziToast.warning({ message: 'Todos los campos son obligatorios' }); return; }
                try {
                    const res = await fetch('/api/admin/deposit-methods', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name, card, confirm, currency,
                            min_amount: isNaN(minAmount) ? 0 : minAmount,
                            max_amount: isNaN(maxAmount) ? 0 : maxAmount,
                            userId: currentUser.telegram_id 
                        })
                    });
                    if (res.ok) { iziToast.success({ message: 'M√©todo a√±adido' }); await loadDepositMethods(); renderViewDataView(); }
                    else { const err = await res.json(); iziToast.error({ message: err.error }); }
                } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
            });
        }

        function renderAddWithdrawView() {
            adminViewContainer.innerHTML = `
                <h4 class="text-xl font-semibold mb-4">‚ûï A√±adir m√©todo de RETIRO</h4>
                <input type="text" id="witName" placeholder="Nombre" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                <input type="text" id="witCard" placeholder="Instrucci√≥n/n√∫mero (ej: n√∫mero de tarjeta)" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                <input type="text" id="witConfirm" placeholder="N√∫mero a confirmar / red" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                <select id="witCurrency" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                    <option value="CUP">CUP</option>
                    <option value="USD">USD</option>
                    <option value="USDT">USDT</option>
                    <option value="TRX">TRX</option>
                    <option value="MLC">MLC</option>
                </select>
                <input type="number" id="witMinAmount" placeholder="L√≠mite m√≠nimo (0 = sin l√≠mite)" step="0.01" min="0" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                <input type="number" id="witMaxAmount" placeholder="L√≠mite m√°ximo (0 = sin l√≠mite)" step="0.01" min="0" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-pink-500 mb-3">
                <button id="saveWithdrawMethodBtn" class="w-full bg-green-600 py-3 rounded-xl font-semibold hover:bg-green-700">Guardar</button>
            `;
            document.getElementById('saveWithdrawMethodBtn')?.addEventListener('click', async () => {
                const name = document.getElementById('witName').value.trim();
                const card = document.getElementById('witCard').value.trim();
                const confirm = document.getElementById('witConfirm').value.trim() || 'ninguno';
                const currency = document.getElementById('witCurrency').value;
                const minAmount = parseFloat(document.getElementById('witMinAmount').value);
                const maxAmount = parseFloat(document.getElementById('witMaxAmount').value);
                if (!name || !card) { iziToast.warning({ message: 'Nombre e instrucci√≥n obligatorios' }); return; }
                try {
                    const res = await fetch('/api/admin/withdraw-methods', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name, card, confirm, currency,
                            min_amount: isNaN(minAmount) ? 0 : minAmount,
                            max_amount: isNaN(maxAmount) ? 0 : maxAmount,
                            userId: currentUser.telegram_id 
                        })
                    });
                    if (res.ok) { iziToast.success({ message: 'M√©todo a√±adido' }); await loadWithdrawMethods(); renderViewDataView(); }
                    else { const err = await res.json(); iziToast.error({ message: err.error }); }
                } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
            });
        }

        async function renderEditDepositView() {
            try {
                const res = await fetch('/api/deposit-methods');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const methods = await res.json();
                let html = `<h4 class="text-xl font-semibold mb-4">‚úèÔ∏è Editar m√©todo de DEP√ìSITO</h4>`;
                if (methods.length === 0) {
                    html += `<p class="text-gray-400">No hay m√©todos.</p>`;
                } else {
                    methods.forEach(m => {
                        html += `<div class="bg-gray-800/70 p-3 rounded-xl mb-2 flex justify-between items-center">
                            <div><span class="font-bold">${escapeHTML(m.name)}</span><br><small>${escapeHTML(m.card)} / ${escapeHTML(m.confirm)} (${m.currency}) M√≠n: ${m.min_amount !== null ? m.min_amount : '-'} M√°x: ${m.max_amount !== null ? m.max_amount : '-'}</small></div>
                            <button onclick="openEditDepositModal(${m.id})" class="method-edit-btn"><i class="fas fa-edit"></i> Editar</button>
                        </div>`;
                    });
                }
                adminViewContainer.innerHTML = html;
            } catch (e) { 
                console.error(e);
                adminViewContainer.innerHTML = '<p class="text-red-400">Error al cargar m√©todos. Verifique la conexi√≥n con el backend.</p>';
            }
        }

        window.openEditDepositModal = async (methodId) => {
            try {
                const res = await fetch(`/api/deposit-methods/${methodId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const method = await res.json();
                modalBody.innerHTML = `
                    <h4 class="text-xl font-bold mb-4">Editar Dep√≥sito ID ${methodId}</h4>
                    <label>Nombre</label>
                    <input type="text" id="editDepName" value="${escapeHTML(method.name)}" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>Datos (card)</label>
                    <input type="text" id="editDepCard" value="${escapeHTML(method.card)}" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>Confirmar</label>
                    <input type="text" id="editDepConfirm" value="${escapeHTML(method.confirm)}" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>Moneda</label>
                    <select id="editDepCurrency" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                        <option value="CUP" ${method.currency === 'CUP' ? 'selected' : ''}>CUP</option>
                        <option value="USD" ${method.currency === 'USD' ? 'selected' : ''}>USD</option>
                        <option value="USDT" ${method.currency === 'USDT' ? 'selected' : ''}>USDT</option>
                        <option value="TRX" ${method.currency === 'TRX' ? 'selected' : ''}>TRX</option>
                        <option value="MLC" ${method.currency === 'MLC' ? 'selected' : ''}>MLC</option>
                    </select>
                    <label>L√≠mite m√≠nimo (0 = sin l√≠mite)</label>
                    <input type="number" id="editDepMinAmount" value="${method.min_amount !== null ? method.min_amount : 0}" step="0.01" min="0" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>L√≠mite m√°ximo (0 = sin l√≠mite)</label>
                    <input type="number" id="editDepMaxAmount" value="${method.max_amount !== null ? method.max_amount : 0}" step="0.01" min="0" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <button onclick="saveEditDeposit(${methodId})" class="w-full bg-green-600 py-2 rounded-lg">Guardar cambios</button>
                    <button onclick="document.getElementById('adminModal').classList.add('hidden')" class="w-full bg-gray-600 py-2 rounded-lg mt-2">Cancelar</button>
                `;
                adminModal.classList.remove('hidden');
            } catch (e) { 
                console.error(e);
                iziToast.error({ message: 'Error al cargar m√©todo' });
            }
        };

        window.saveEditDeposit = async (methodId) => {
            const name = document.getElementById('editDepName').value.trim();
            const card = document.getElementById('editDepCard').value.trim();
            const confirm = document.getElementById('editDepConfirm').value.trim();
            const currency = document.getElementById('editDepCurrency').value;
            const minAmount = parseFloat(document.getElementById('editDepMinAmount').value);
            const maxAmount = parseFloat(document.getElementById('editDepMaxAmount').value);
            if (!name || !card || !confirm) { iziToast.warning({ message: 'Todos los campos son obligatorios' }); return; }
            try {
                const res = await fetch(`/api/admin/deposit-methods/${methodId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name, card, confirm, currency,
                        min_amount: isNaN(minAmount) ? 0 : minAmount,
                        max_amount: isNaN(maxAmount) ? 0 : maxAmount,
                        userId: currentUser.telegram_id 
                    })
                });
                if (res.ok) {
                    iziToast.success({ message: 'M√©todo actualizado' });
                    adminModal.classList.add('hidden');
                    await loadDepositMethods();
                    renderEditDepositView();
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        };

        async function renderEditWithdrawView() {
            try {
                const res = await fetch('/api/withdraw-methods');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const methods = await res.json();
                let html = `<h4 class="text-xl font-semibold mb-4">‚úèÔ∏è Editar m√©todo de RETIRO</h4>`;
                if (methods.length === 0) {
                    html += `<p class="text-gray-400">No hay m√©todos.</p>`;
                } else {
                    methods.forEach(m => {
                        html += `<div class="bg-gray-800/70 p-3 rounded-xl mb-2 flex justify-between items-center">
                            <div><span class="font-bold">${escapeHTML(m.name)}</span><br><small>${escapeHTML(m.card)} / ${escapeHTML(m.confirm)} (${m.currency}) M√≠n: ${m.min_amount !== null ? m.min_amount : '-'} M√°x: ${m.max_amount !== null ? m.max_amount : '-'}</small></div>
                            <button onclick="openEditWithdrawModal(${m.id})" class="method-edit-btn"><i class="fas fa-edit"></i> Editar</button>
                        </div>`;
                    });
                }
                adminViewContainer.innerHTML = html;
            } catch (e) { 
                console.error(e);
                adminViewContainer.innerHTML = '<p class="text-red-400">Error al cargar m√©todos. Verifique la conexi√≥n con el backend.</p>';
            }
        }

        window.openEditWithdrawModal = async (methodId) => {
            try {
                const res = await fetch(`/api/withdraw-methods/${methodId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const method = await res.json();
                modalBody.innerHTML = `
                    <h4 class="text-xl font-bold mb-4">Editar Retiro ID ${methodId}</h4>
                    <label>Nombre</label>
                    <input type="text" id="editWitName" value="${escapeHTML(method.name)}" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>Instrucci√≥n/N√∫mero</label>
                    <input type="text" id="editWitCard" value="${escapeHTML(method.card)}" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>N√∫mero a confirmar</label>
                    <input type="text" id="editWitConfirm" value="${escapeHTML(method.confirm)}" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>Moneda</label>
                    <select id="editWitCurrency" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                        <option value="CUP" ${method.currency === 'CUP' ? 'selected' : ''}>CUP</option>
                        <option value="USD" ${method.currency === 'USD' ? 'selected' : ''}>USD</option>
                        <option value="USDT" ${method.currency === 'USDT' ? 'selected' : ''}>USDT</option>
                        <option value="TRX" ${method.currency === 'TRX' ? 'selected' : ''}>TRX</option>
                        <option value="MLC" ${method.currency === 'MLC' ? 'selected' : ''}>MLC</option>
                    </select>
                    <label>L√≠mite m√≠nimo (0 = sin l√≠mite)</label>
                    <input type="number" id="editWitMinAmount" value="${method.min_amount !== null ? method.min_amount : 0}" step="0.01" min="0" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <label>L√≠mite m√°ximo (0 = sin l√≠mite)</label>
                    <input type="number" id="editWitMaxAmount" value="${method.max_amount !== null ? method.max_amount : 0}" step="0.01" min="0" class="w-full p-2 rounded bg-gray-700 text-white mb-3">
                    <button onclick="saveEditWithdraw(${methodId})" class="w-full bg-green-600 py-2 rounded-lg">Guardar cambios</button>
                    <button onclick="document.getElementById('adminModal').classList.add('hidden')" class="w-full bg-gray-600 py-2 rounded-lg mt-2">Cancelar</button>
                `;
                adminModal.classList.remove('hidden');
            } catch (e) { 
                console.error(e);
                iziToast.error({ message: 'Error al cargar m√©todo' });
            }
        };

        window.saveEditWithdraw = async (methodId) => {
            const name = document.getElementById('editWitName').value.trim();
            const card = document.getElementById('editWitCard').value.trim();
            const confirm = document.getElementById('editWitConfirm').value.trim();
            const currency = document.getElementById('editWitCurrency').value;
            const minAmount = parseFloat(document.getElementById('editWitMinAmount').value);
            const maxAmount = parseFloat(document.getElementById('editWitMaxAmount').value);
            if (!name || !card) { iziToast.warning({ message: 'Nombre e instrucci√≥n son obligatorios' }); return; }
            try {
                const res = await fetch(`/api/admin/withdraw-methods/${methodId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name, card, confirm, currency,
                        min_amount: isNaN(minAmount) ? 0 : minAmount,
                        max_amount: isNaN(maxAmount) ? 0 : maxAmount,
                        userId: currentUser.telegram_id 
                    })
                });
                if (res.ok) {
                    iziToast.success({ message: 'M√©todo actualizado' });
                    adminModal.classList.add('hidden');
                    await loadWithdrawMethods();
                    renderEditWithdrawView();
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        };

        async function renderDeleteDepositView() {
            try {
                const res = await fetch('/api/deposit-methods');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const methods = await res.json();
                let html = `<h4 class="text-xl font-semibold mb-4">üóë Eliminar m√©todo de DEP√ìSITO</h4>`;
                if (methods.length === 0) {
                    html += `<p class="text-gray-400">No hay m√©todos.</p>`;
                } else {
                    methods.forEach(m => {
                        html += `<div class="bg-gray-800/70 p-3 rounded-xl mb-2 flex justify-between items-center">
                            <div><span class="font-bold">${escapeHTML(m.name)}</span><br><small>${escapeHTML(m.card)} / ${escapeHTML(m.confirm)}</small></div>
                            <button onclick="deleteDepositMethod(${m.id})" class="method-delete-btn"><i class="fas fa-trash"></i> Eliminar</button>
                        </div>`;
                    });
                }
                adminViewContainer.innerHTML = html;
            } catch (e) { 
                console.error(e);
                adminViewContainer.innerHTML = '<p class="text-red-400">Error al cargar m√©todos.</p>';
            }
        }

        window.deleteDepositMethod = async (methodId) => {
            if (!confirm('¬øEst√°s seguro de eliminar este m√©todo?')) return;
            try {
                const res = await fetch(`/api/admin/deposit-methods/${methodId}?userId=${currentUser.telegram_id}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    iziToast.success({ message: 'M√©todo eliminado' });
                    await loadDepositMethods();
                    renderDeleteDepositView();
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        };

        async function renderDeleteWithdrawView() {
            try {
                const res = await fetch('/api/withdraw-methods');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const methods = await res.json();
                let html = `<h4 class="text-xl font-semibold mb-4">üóë Eliminar m√©todo de RETIRO</h4>`;
                if (methods.length === 0) {
                    html += `<p class="text-gray-400">No hay m√©todos.</p>`;
                } else {
                    methods.forEach(m => {
                        html += `<div class="bg-gray-800/70 p-3 rounded-xl mb-2 flex justify-between items-center">
                            <div><span class="font-bold">${escapeHTML(m.name)}</span><br><small>${escapeHTML(m.card)} / ${escapeHTML(m.confirm)}</small></div>
                            <button onclick="deleteWithdrawMethod(${m.id})" class="method-delete-btn"><i class="fas fa-trash"></i> Eliminar</button>
                        </div>`;
                    });
                }
                adminViewContainer.innerHTML = html;
            } catch (e) { 
                console.error(e);
                adminViewContainer.innerHTML = '<p class="text-red-400">Error al cargar m√©todos.</p>';
            }
        }

        window.deleteWithdrawMethod = async (methodId) => {
            if (!confirm('¬øEst√°s seguro de eliminar este m√©todo?')) return;
            try {
                const res = await fetch(`/api/admin/withdraw-methods/${methodId}?userId=${currentUser.telegram_id}`, {
                    method: 'DELETE'
                });
                if (res.ok) {
                    iziToast.success({ message: 'M√©todo eliminado' });
                    await loadWithdrawMethods();
                    renderDeleteWithdrawView();
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        };

        function renderSetRateView() {
            adminViewContainer.innerHTML = `
                <h4 class="text-xl font-semibold mb-4">üí∞ Configurar Tasas de Cambio</h4>
                <p class="mb-2">Tasa USD/CUP actual: <span class="text-cyan-300 font-bold">1 USD = ${exchangeRates.rate} CUP</span></p>
                <input type="number" id="newRateUSD" value="${exchangeRates.rate}" step="0.01" min="1" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-green-500 mb-3">
                <button id="updateRateUSDBtn" class="w-full bg-green-600 py-2 rounded-xl mb-4">Actualizar USD/CUP</button>
                
                <p class="mb-2">Tasa USDT/CUP actual: <span class="text-cyan-300 font-bold">1 USDT = ${exchangeRates.rate_usdt} CUP</span></p>
                <input type="number" id="newRateUSDT" value="${exchangeRates.rate_usdt}" step="0.01" min="1" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-green-500 mb-3">
                <button id="updateRateUSDTBtn" class="w-full bg-green-600 py-2 rounded-xl mb-4">Actualizar USDT/CUP</button>
                
                <p class="mb-2">Tasa TRX/CUP actual: <span class="text-cyan-300 font-bold">1 TRX = ${exchangeRates.rate_trx} CUP</span></p>
                <input type="number" id="newRateTRX" value="${exchangeRates.rate_trx}" step="0.01" min="0.01" class="w-full p-3 rounded-xl bg-gray-800 text-white border border-green-500 mb-3">
                <button id="updateRateTRXBtn" class="w-full bg-green-600 py-2 rounded-xl">Actualizar TRX/CUP</button>
            `;
            
            document.getElementById('updateRateUSDBtn')?.addEventListener('click', async () => {
                const rate = parseFloat(document.getElementById('newRateUSD').value);
                if (isNaN(rate) || rate <= 0) { iziToast.warning({ message: 'Tasa inv√°lida' }); return; }
                try {
                    const res = await fetch('/api/admin/exchange-rate/usd', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rate, userId: currentUser.telegram_id })
                    });
                    if (res.ok) { exchangeRates.rate = rate; iziToast.success({ message: 'Tasa USD/CUP actualizada' }); renderViewDataView(); }
                    else { const err = await res.json(); iziToast.error({ message: err.error }); }
                } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
            });
            
            document.getElementById('updateRateUSDTBtn')?.addEventListener('click', async () => {
                const rate = parseFloat(document.getElementById('newRateUSDT').value);
                if (isNaN(rate) || rate <= 0) { iziToast.warning({ message: 'Tasa inv√°lida' }); return; }
                try {
                    const res = await fetch('/api/admin/exchange-rate/usdt', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rate, userId: currentUser.telegram_id })
                    });
                    if (res.ok) { exchangeRates.rate_usdt = rate; iziToast.success({ message: 'Tasa USDT/CUP actualizada' }); renderViewDataView(); }
                    else { const err = await res.json(); iziToast.error({ message: err.error }); }
                } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
            });
            
            document.getElementById('updateRateTRXBtn')?.addEventListener('click', async () => {
                const rate = parseFloat(document.getElementById('newRateTRX').value);
                if (isNaN(rate) || rate <= 0) { iziToast.warning({ message: 'Tasa inv√°lida' }); return; }
                try {
                    const res = await fetch('/api/admin/exchange-rate/trx', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rate, userId: currentUser.telegram_id })
                    });
                    if (res.ok) { exchangeRates.rate_trx = rate; iziToast.success({ message: 'Tasa TRX/CUP actualizada' }); renderViewDataView(); }
                    else { const err = await res.json(); iziToast.error({ message: err.error }); }
                } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
            });
        }

        async function renderSetPricesView() {
            try {
                const res = await fetch('/api/play-prices');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const prices = await res.json();
                let html = `<h4 class="text-xl font-semibold mb-4">üé≤ Pagos, M√≠nimos y M√°ximos</h4>`;
                prices.forEach(p => {
                    html += `<div class="mb-6 bg-gray-800/50 p-4 rounded-xl">
                        <span class="font-bold text-lg mb-2 block">${p.bet_type}</span>
                        
                        <div class="mb-3 p-3 bg-gray-700/30 rounded-lg">
                            <p class="text-sm font-semibold text-yellow-300 mb-2">üéÅ PAGO (MULTIPLICADOR)</p>
                            <input type="number" id="multiplier_${p.bet_type}" value="${p.payout_multiplier || 500}" placeholder="Multiplicador" step="0.1" min="0" class="w-32 p-2 rounded bg-gray-700 text-white text-sm mb-2">
                        </div>

                        <div class="p-3 bg-gray-700/30 rounded-lg">
                            <p class="text-sm font-semibold text-gray-300 mb-2">üìâ MONTOS M√çNIMOS</p>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <div class="flex items-center gap-1">
                                    <span class="text-xs">CUP:</span>
                                    <input type="number" id="min_cup_${p.bet_type}" value="${p.min_cup || 0}" step="0.01" min="0" class="w-20 p-2 rounded bg-gray-700 text-white text-sm">
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-xs">USD:</span>
                                    <input type="number" id="min_usd_${p.bet_type}" value="${p.min_usd || 0}" step="0.01" min="0" class="w-20 p-2 rounded bg-gray-700 text-white text-sm">
                                </div>
                            </div>
                            <p class="text-sm font-semibold text-gray-300 mb-2">üìà MONTOS M√ÅXIMOS</p>
                            <div class="flex flex-wrap gap-2">
                                <div class="flex items-center gap-1">
                                    <span class="text-xs">CUP:</span>
                                    <input type="number" id="max_cup_${p.bet_type}" value="${p.max_cup !== null ? p.max_cup : 0}" step="0.01" min="0" class="w-20 p-2 rounded bg-gray-700 text-white text-sm">
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="text-xs">USD:</span>
                                    <input type="number" id="max_usd_${p.bet_type}" value="${p.max_usd !== null ? p.max_usd : 0}" step="0.01" min="0" class="w-20 p-2 rounded bg-gray-700 text-white text-sm">
                                </div>
                                <button onclick="updatePlayPrice('${p.bet_type}')" class="ml-auto bg-blue-600 px-4 py-2 rounded-lg text-sm hover:bg-blue-700">Actualizar</button>
                            </div>
                        </div>
                    </div>`;
                });
                adminViewContainer.innerHTML = html;
            } catch (e) { 
                console.error(e);
                adminViewContainer.innerHTML = '<p class="text-red-400">Error al cargar precios.</p>';
            }
        }

        window.updatePlayPrice = async (betType) => {
            const multiplier = parseFloat(document.getElementById(`multiplier_${betType}`).value);
            const minCup = parseFloat(document.getElementById(`min_cup_${betType}`).value);
            const minUsd = parseFloat(document.getElementById(`min_usd_${betType}`).value);
            const maxCup = parseFloat(document.getElementById(`max_cup_${betType}`).value);
            const maxUsd = parseFloat(document.getElementById(`max_usd_${betType}`).value);
            if (isNaN(multiplier) || isNaN(minCup) || isNaN(minUsd) || isNaN(maxCup) || isNaN(maxUsd) || multiplier < 0 || minCup < 0 || minUsd < 0 || maxCup < 0 || maxUsd < 0) {
                iziToast.warning({ message: 'Valores inv√°lidos' }); return;
            }
            try {
                const res = await fetch(`/api/admin/play-prices/${betType}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        payout_multiplier: multiplier, 
                        min_cup: minCup, 
                        min_usd: minUsd,
                        max_cup: maxCup === 0 ? null : maxCup,
                        max_usd: maxUsd === 0 ? null : maxUsd,
                        userId: currentUser.telegram_id 
                    })
                });
                if (res.ok) {
                    iziToast.success({ message: 'Pagos, m√≠nimos y m√°ximos actualizados' });
                    await loadPlayPrices();
                    renderSetPricesView();
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error });
                }
            } catch (e) { iziToast.error({ message: 'Error de conexi√≥n' }); }
        };

        async function renderViewDataView() {
            try {
                const depRes = await fetch('/api/deposit-methods');
                const depMethods = await depRes.json();
                const witRes = await fetch('/api/withdraw-methods');
                const witMethods = await witRes.json();
                const priceRes = await fetch('/api/play-prices');
                const prices = await priceRes.json();

                let text = `üí∞ <b>Tasas:</b>\n`;
                text += `USD/CUP: 1 USD = ${exchangeRates.rate} CUP\n`;
                text += `USDT/CUP: 1 USDT = ${exchangeRates.rate_usdt} CUP\n`;
                text += `TRX/CUP: 1 TRX = ${exchangeRates.rate_trx} CUP\n\n`;
                text += `üì• <b>M√©todos DEP√ìSITO:</b>\n`;
                depMethods.forEach(m => text += `  ‚Ä¢ ${m.name} (${m.currency}) - ${m.card} / ${m.confirm} | M√≠n: ${m.min_amount !== null ? m.min_amount : '-'} | M√°x: ${m.max_amount !== null ? m.max_amount : '-'}\n`);
                text += `\nüì§ <b>M√©todos RETIRO:</b>\n`;
                witMethods.forEach(m => text += `  ‚Ä¢ ${m.name} (${m.currency}) - ${m.card} / ${m.confirm} | M√≠n: ${m.min_amount !== null ? m.min_amount : '-'} | M√°x: ${m.max_amount !== null ? m.max_amount : '-'}\n`);
                text += `\nüé≤ <b>Pagos, M√≠nimos y M√°ximos por jugada:</b>\n`;
                prices.forEach(p => text += 
                    `  ‚Ä¢ ${p.bet_type}: Pago x${p.payout_multiplier || 0}  |  M√≠n: ${p.min_cup||0} CUP / ${p.min_usd||0} USD  |  M√°x: ${p.max_cup||'‚àû'} CUP / ${p.max_usd||'‚àû'} USD\n`
                );

                adminViewContainer.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-sm text-gray-200 bg-gray-800/50 p-4 rounded-xl">${text}</pre>`;
            } catch (e) { 
                console.error(e);
                adminViewContainer.innerHTML = '<p class="text-red-400">Error al cargar datos.</p>';
            }
        }

        async function renderPendingRequestsView() {
            let html = `
                <h4 class="text-xl font-semibold mb-4">‚è≥ Solicitudes Pendientes</h4>
                <div class="tab-buttons">
                    <div class="tab-button active" data-tab="deposits">Dep√≥sitos</div>
                    <div class="tab-button" data-tab="withdraws">Retiros</div>
                </div>
                <div id="pendingTabContent" class="mt-3"></div>
            `;
            adminViewContainer.innerHTML = html;

            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContent = document.getElementById('pendingTabContent');

            async function loadTab(tab) {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

                if (tab === 'deposits') {
                    try {
                        const res = await fetch(`/api/admin/pending-deposits?userId=${currentUser.telegram_id}`);
                        if (!res.ok) throw new Error('Error al cargar dep√≥sitos');
                        const deposits = await res.json();
                        if (deposits.length === 0) {
                            tabContent.innerHTML = '<p class="text-gray-400 text-center py-4">No hay solicitudes de dep√≥sito pendientes.</p>';
                        } else {
                            let listHtml = '';
                            deposits.forEach(d => {
                                listHtml += `
                                    <div class="pending-item" id="deposit-${d.id}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p><strong>Usuario:</strong> ${escapeHTML(d.user_name)} (${d.user_id})</p>
                                                <p><strong>Monto:</strong> ${d.amount} ${d.currency}</p>
                                                <p><strong>M√©todo:</strong> ${escapeHTML(d.method_name)}</p>
                                                <p><strong>Captura:</strong> <a href="${d.screenshot_url}" target="_blank" class="text-cyan-400">Ver</a></p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="handlePending('deposit', ${d.id}, 'approve')" class="bg-green-600 px-3 py-1 rounded-lg text-sm">‚úÖ Aprobar</button>
                                                <button onclick="handlePending('deposit', ${d.id}, 'reject')" class="bg-red-600 px-3 py-1 rounded-lg text-sm">‚ùå Rechazar</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            tabContent.innerHTML = listHtml;
                        }
                    } catch (e) {
                        // Si el endpoint no existe, mostramos mensaje y datos de ejemplo
                        console.warn('Error cargando dep√≥sitos pendientes:', e);
                        tabContent.innerHTML = `
                            <p class="text-yellow-300 mb-3">‚ö†Ô∏è Endpoint no disponible. Mostrando datos de ejemplo:</p>
                            <div class="pending-item">
                                <div class="flex justify-between">
                                    <div><strong>Usuario:</strong> Juan P√©rez (12345)<br><strong>Monto:</strong> 500 CUP<br><strong>M√©todo:</strong> Transferencia Bancaria</div>
                                    <div class="flex gap-2"><button class="bg-green-600 px-3 py-1 rounded-lg">‚úÖ Aprobar</button><button class="bg-red-600 px-3 py-1 rounded-lg">‚ùå Rechazar</button></div>
                                </div>
                            </div>
                            <div class="pending-item">
                                <div class="flex justify-between">
                                    <div><strong>Usuario:</strong> Mar√≠a G√≥mez (67890)<br><strong>Monto:</strong> 20 USDT<br><strong>M√©todo:</strong> USDT (TRC-20)</div>
                                    <div class="flex gap-2"><button class="bg-green-600 px-3 py-1 rounded-lg">‚úÖ Aprobar</button><button class="bg-red-600 px-3 py-1 rounded-lg">‚ùå Rechazar</button></div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    try {
                        const res = await fetch(`/api/admin/pending-withdraws?userId=${currentUser.telegram_id}`);
                        if (!res.ok) throw new Error('Error al cargar retiros');
                        const withdraws = await res.json();
                        if (withdraws.length === 0) {
                            tabContent.innerHTML = '<p class="text-gray-400 text-center py-4">No hay solicitudes de retiro pendientes.</p>';
                        } else {
                            let listHtml = '';
                            withdraws.forEach(w => {
                                listHtml += `
                                    <div class="pending-item" id="withdraw-${w.id}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p><strong>Usuario:</strong> ${escapeHTML(w.user_name)} (${w.user_id})</p>
                                                <p><strong>Monto:</strong> ${w.amount} ${w.currency}</p>
                                                <p><strong>M√©todo:</strong> ${escapeHTML(w.method_name)}</p>
                                                <p><strong>Cuenta:</strong> ${escapeHTML(w.account_info)}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="handlePending('withdraw', ${w.id}, 'approve')" class="bg-green-600 px-3 py-1 rounded-lg text-sm">‚úÖ Aprobar</button>
                                                <button onclick="handlePending('withdraw', ${w.id}, 'reject')" class="bg-red-600 px-3 py-1 rounded-lg text-sm">‚ùå Rechazar</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            tabContent.innerHTML = listHtml;
                        }
                    } catch (e) {
                        console.warn('Error cargando retiros pendientes:', e);
                        tabContent.innerHTML = `
                            <p class="text-yellow-300 mb-3">‚ö†Ô∏è Endpoint no disponible. Mostrando datos de ejemplo:</p>
                            <div class="pending-item">
                                <div class="flex justify-between">
                                    <div><strong>Usuario:</strong> Carlos Ruiz (54321)<br><strong>Monto:</strong> 50 USD<br><strong>M√©todo:</strong> PayPal<br><strong>Cuenta:</strong> carlos@email.com</div>
                                    <div class="flex gap-2"><button class="bg-green-600 px-3 py-1 rounded-lg">‚úÖ Aprobar</button><button class="bg-red-600 px-3 py-1 rounded-lg">‚ùå Rechazar</button></div>
                                </div>
                            </div>
                        `;
                    }
                }
            }

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    loadTab(btn.dataset.tab);
                });
            });

            loadTab('deposits');
        }

        window.handlePending = async (type, id, action) => {
            const endpoint = type === 'deposit' ? `/api/admin/pending-deposits/${id}/${action}` : `/api/admin/pending-withdraws/${id}/${action}`;
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.telegram_id })
                });
                if (res.ok) {
                    iziToast.success({ message: `Solicitud ${action === 'approve' ? 'aprobada' : 'rechazada'} correctamente` });
                    // Recargar la pesta√±a activa
                    const activeTab = document.querySelector('.tab-button.active').dataset.tab;
                    const pendingTabContent = document.getElementById('pendingTabContent');
                    // Simular recarga de la pesta√±a llamando a loadTab
                    const tabButtons = document.querySelectorAll('.tab-button');
                    const loadTab = async (tab) => {
                        // Re-ejecutar la l√≥gica de renderPendingRequestsView simplificada
                        // En este contexto, simplemente recargamos la vista completa
                        renderPendingRequestsView();
                    };
                    renderPendingRequestsView(); // Recarga completa
                } else {
                    const err = await res.json();
                    iziToast.error({ message: err.error || 'Error al procesar la solicitud' });
                }
            } catch (e) {
                iziToast.error({ message: 'Error de conexi√≥n' });
                console.error(e);
            }
        };

        adminNavBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (!isAdmin) return;
                const view = e.currentTarget.dataset.adminView;
                if (view === 'sessions') renderSessionsView();
                else if (view === 'publishWinning') renderPublishWinningView();
                else if (view === 'addDeposit') renderAddDepositView();
                else if (view === 'addWithdraw') renderAddWithdrawView();
                else if (view === 'editDeposit') renderEditDepositView();
                else if (view === 'editWithdraw') renderEditWithdrawView();
                else if (view === 'deleteDeposit') renderDeleteDepositView();
                else if (view === 'deleteWithdraw') renderDeleteWithdrawView();
                else if (view === 'setRate') renderSetRateView();
                else if (view === 'setPrices') renderSetPricesView();
                else if (view === 'viewData') renderViewDataView();
                else if (view === 'pendingRequests') renderPendingRequestsView();
            });
        });

        // Iniciar autenticaci√≥n
        initAuth();

        // Timeout de seguridad por si la carga se demora
        setTimeout(() => {
            if (!globalLoader.classList.contains('hidden')) {
                globalLoader.innerHTML = `
                    <div class="error-box">
                        <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
                        <p class="text-xl font-bold mb-2">Tiempo de espera agotado</p>
                        <p class="text-sm mb-4">El servidor no responde. Verifica tu conexi√≥n o int√©ntalo m√°s tarde.</p>
                        <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl">
                            <i class="fas fa-sync-alt mr-2"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }, 15000); // 15 segundos

        function escapeHTML(str) {
            return String(str).replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        function parseAmountWithCurrency(text) {
            const lower = text.toLowerCase().replace(',', '.').trim();
            const match = lower.match(/^(\d+(?:\.\d+)?)\s*(cup|usd|usdt|trx|mlc)$/);
            if (!match) return null;
            return {
                amount: parseFloat(match[1]),
                currency: match[2].toUpperCase()
            };
        }
    })();
</script>
</body>
</html>
